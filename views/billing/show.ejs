<%- include('../partials/header') %>

<div class="card my-4 col-12 col-lg-10 mx-auto shadow-lg border-0 rounded-4">
    <div class="card-header bg-dark text-white d-flex flex-wrap justify-content-between align-items-center py-3 shadow-sm">
        <h4 class="card-title mb-2 mb-md-0 text-truncate">
            Invoice #<%= invoice._id.toString().substring(18).toUpperCase() %>
        </h4>
        <span class="badge rounded-pill fs-6 px-3 py-2 bg-<%= invoice.status === 'Paid' ? 'success' : invoice.status === 'Pending' ? 'warning' : 'danger' %>">
            <%= invoice.status %>
        </span>
    </div>

    <div class="card-body p-3 p-md-4">
        <div class="row mb-4 border-bottom pb-3 gy-3">
            <div class="col-12 col-md-6">
                <h6 class="text-secondary fw-bold mb-1">Billed To:</h6>
                <p class="fw-semibold fs-5 mb-1"><%= invoice.patient.name %></p>
                <p class="mb-1"><i class="bi bi-telephone"></i> <%= invoice.patient.contact %></p>
                <p class="mb-1"><i class="bi bi-geo-alt"></i> <%= invoice.patient.address %></p>
            </div>

            <div class="col-12 col-md-6 text-md-end">
                <h6 class="text-secondary fw-bold mb-1">Invoice Info:</h6>
                <p class="mb-1"><strong>Date:</strong> <%= invoice.createdAt.toLocaleDateString() %></p>
                <p class="mb-0"><strong>Payment Method:</strong> <%= invoice.paymentMethod || 'N/A' %></p>
            </div>
        </div>

        <h5 class="fw-bold mb-3 text-primary">Item Details</h5>
        <div class="table-responsive mb-4">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark text-white">
                    <tr>
                        <th>#</th>
                        <th>Description</th>
                        <th class="text-end">Qty</th>
                        <th class="text-end">Unit Price</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <% invoice.items.forEach((item, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td><%= item.description %></td>
                            <td class="text-end"><%= item.quantity %></td>
                            <td class="text-end">‚Çπ<%= item.unitPrice.toFixed(2) %></td>
                            <td class="text-end fw-semibold">‚Çπ<%= item.total.toFixed(2) %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <div class="row justify-content-end">
            <div class="col-12 col-md-6 col-lg-4">
                <div class="border rounded-3 p-3 bg-light">
                    <table class="table table-sm mb-0">
                        <tr>
                            <td>Sub Total:</td>
                            <td class="text-end">‚Çπ<%= invoice.subTotal.toFixed(2) %></td>
                        </tr>
                        <tr>
                            <td>Tax (<%= (invoice.taxRate * 100).toFixed(0) %>%):</td>
                            <td class="text-end">‚Çπ<%= invoice.taxAmount.toFixed(2) %></td>
                        </tr>
                        <tr class="fw-bold fs-5 table-success">
                            <td>Grand Total:</td>
                            <td class="text-end text-success">‚Çπ<%= invoice.grandTotal.toFixed(2) %></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <hr class="mt-4 mb-3">

        <h5 class="fw-bold mb-3 text-secondary">Update Payment Status</h5>
        <form action="/billing/<%= invoice._id %>?_method=PUT" method="POST" class="row gy-3 gx-3 align-items-end">
            <div class="col-12 col-md-4">
                <label for="status" class="form-label mb-1">Status</label>
                <select class="form-select" id="status" name="status" required>
                    <option value="Pending" <%= invoice.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                    <option value="Paid" <%= invoice.status === 'Paid' ? 'selected' : '' %>>Paid</option>
                    <option value="Cancelled" <%= invoice.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                </select>
            </div>

            <div class="col-12 col-md-4">
                <label for="paymentMethod" class="form-label mb-1">Payment Method</label>
                <select class="form-select" id="paymentMethod" name="paymentMethod">
                    <option value="">N/A</option>
                    <option value="Cash" <%= invoice.paymentMethod === 'Cash' ? 'selected' : '' %>>Cash</option>
                    <option value="Card" <%= invoice.paymentMethod === 'Card' ? 'selected' : '' %>>Card</option>
                    <option value="Online" <%= invoice.paymentMethod === 'Online' ? 'selected' : '' %>>Online Transfer</option>
                </select>
            </div>

            <div class="col-12 col-md-4">
                <button type="submit" class="btn btn-warning w-100 fw-semibold">
                    üíæ Update Status
                </button>
            </div>
        </form>

        <% if (invoice.status === 'Pending') { %>
            <div class="alert alert-info mt-4">
                <i class="bi bi-credit-card"></i> Testing Only: Simulate successful online payment.
            </div>
            <div class="d-grid">
                <button type="button" class="btn btn-success btn-lg shadow-sm" onclick="startMockPayment('<%= invoice._id %>')">
                    üí≥ Simulate Payment (‚Çπ<%= invoice.grandTotal.toFixed(2) %>)
                </button>
            </div>
        <% } %>

        <div class="d-grid d-md-flex justify-content-md-between mt-4">
             <a href="/billing/<%= invoice._id %>/pdf" class="btn btn-primary btn-lg shadow-sm mb-3 mb-md-0 w-100 w-md-auto" target="_blank">
                <i class="bi bi-file-earmark-pdf"></i> Download PDF Invoice
            </a>
            <a href="/billing" class="btn btn-secondary btn-lg w-100 w-md-auto">
                ‚Üê Back to Invoices
            </a>
        </div>
        
    </div>
</div>

<script>
async function startMockPayment(invoiceId) {
    if (!confirm("Confirm to simulate successful online payment and mark as Paid?")) return;

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

    try {
        const res = await fetch('/billing/mockPay', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ invoiceId })
        });

        const data = await res.json();
        if (data.status === 'success') {
            alert('‚úÖ Payment simulated successfully!');
            location.reload();
        } else {
            alert('‚ùå Failed: ' + (data.message || 'Server error.'));
            btn.disabled = false;
            btn.innerHTML = 'Simulate Payment';
        }
    } catch (err) {
        alert('‚ö†Ô∏è Network or server error.');
        btn.disabled = false;
        btn.innerHTML = 'Simulate Payment';
    }
}
</script>

<%- include('../partials/footer') %>